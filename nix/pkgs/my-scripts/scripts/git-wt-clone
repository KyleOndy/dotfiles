#!/usr/bin/env bash

# Clone and setup a repo for use with git worktree workflow

# Source common library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck disable=SC1091
source "${SCRIPT_DIR}/../lib/common.sh"

set_strict_mode

# Show help text
if [[ $# -eq 0 ]]; then
  cat << 'EOF'
usage: git wt-clone <url> [name]

Clone a repository and set it up for git worktree workflow.

Creates a directory with:
  .bare/              - Bare repository
  .git                - Points to .bare
  <default-branch>/   - Initial worktree for default branch

Arguments:
  url   - Git repository URL to clone
  name  - Directory name (optional, defaults to repository name)

Examples:
  git wt-clone https://github.com/user/repo
    → Creates ./repo/ with main/ or master/ worktree

  git wt-clone https://github.com/user/repo my-project
    → Creates ./my-project/ with main/ or master/ worktree

After cloning, use git wt-feature-branch to create feature worktrees.
EOF
  exit 0
fi

readonly url=$1
readonly basename=${url##*/}
readonly name=${2:-${basename%.*}}

# Validate inputs
if [[ -z "$url" ]]; then
  die "Repository URL required
Usage: git wt-clone <url> [name]"
fi

if [[ -e "$name" ]]; then
  die "Directory '$name' already exists"
fi

# Detect default branch
log_info "Detecting default branch..."
default_branch=$(get_default_branch_from_url "$url")
readonly default_branch
log_info "Default branch: $default_branch"

# Create directory structure
mkdir "$name"
cd "$name" || die "Failed to change to directory: $name"

# Clone as bare repository
log_info "Cloning repository..."
git clone --bare "$url" .bare

# Set up git directory pointer
echo "gitdir: ./.bare" > .git

# Configure remote fetch
git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"

# Fetch remote branches to populate remote tracking references
git fetch origin

# Create initial worktree for default branch
log_info "Creating worktree for '$default_branch'..."
git worktree add --no-checkout "$default_branch" "$default_branch"

# Set up git-crypt for new worktree if configured
if git config --get filter.git-crypt.smudge &>/dev/null; then
  log_info "Setting up git-crypt..."

  # Get the worktree's git directory
  worktree_git_dir=$(git -C "$default_branch" rev-parse --git-dir)

  # Create git-crypt keys directory
  mkdir -p "$worktree_git_dir/git-crypt/keys"

  # Decrypt the symmetric key from the repo using GPG
  # Try each .gpg file (in case multiple collaborators) and use the first successful decryption
  for gpg_key in .git-crypt/keys/default/0/*.gpg; do
    if [ -f "$gpg_key" ]; then
      if gpg --decrypt --quiet "$gpg_key" > "$worktree_git_dir/git-crypt/keys/default" 2>/dev/null; then
        break
      fi
    fi
  done
fi

# Checkout files after git-crypt is unlocked
log_info "Checking out files..."
(cd "$default_branch" && git checkout "$default_branch")

# Set up tracking for default branch
cd "$default_branch" || die "Failed to change to directory: $default_branch"
git branch -u "origin/${default_branch}" "$default_branch"

# Success summary
echo ""
log_info "Repository cloned and configured for worktree workflow"
log_info "Directory: $name/"
log_info "Initial worktree: $name/$default_branch/"
echo ""
echo "To start working:"
echo "  cd $name/$default_branch"
echo ""
echo "To create feature worktrees:"
echo "  git wt-feature-branch <name>              # Home mode"
echo "  git wt-feature-branch <ticket> <name>     # Work mode"
