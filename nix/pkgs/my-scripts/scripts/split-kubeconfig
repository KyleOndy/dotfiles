#!/usr/bin/env bash

# Source common library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck disable=SC1091
source "${SCRIPT_DIR}/../lib/common.sh"

set_strict_mode

if [ "$#" -ne 1 ] || ! [ -f "$1" ]; then
	die "usage: $0 <flattened_kube_config>"
fi

export KUBECONFIG="$1"

for context in $(kubectl config get-contexts --output name); do
	kubectl --context "$context" config view --minify --flatten >"$HOME/.kube/configs/$context"
done

chmod 600 "$HOME/.kube/configs/*"
